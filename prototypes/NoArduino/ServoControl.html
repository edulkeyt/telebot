<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd"> 
<html lang="en"> 
	<head> 
		<meta http-equiv="content-type" content="text/html; charset=utf-8" > 
		<title>Servo control</title>
		<style type="text/css">
			.control-left{
				display: inline-block; 
			}		
			.control-right{
				display: inline-block; 
				position: absolute; 
				right: 0px; 
			}
			.joystick{
				height:300px; 
				width:300px;
			}
			.light-blue-background{
				background-color: #a9c9ff;
			}
			.light-pink-background{
				background-color: #c9c9ff;
			}
			.light-green-background{
				background-color: #c9ffc9;
			}
			.light-orange-background{
				background-color: #ffffc9;
			}
			.camera{
				width: 640px;
				height: 480px;				
				/* background-color: #c999c9; */
				display: block;
				margin: auto;
			}
		</style>
		<link rel="stylesheet" type="text/css" href="controls/wheelsJoystick/wheelsJoystick.css">
	</head> 
	<body> 
		<div id="controlPanel">
			<div class="upper-panel">
				<div id="camera" class="camera">
					<img src='http://192.168.1.40:8900/1.mjpg'/>
				</div>							
			</div>
			<div>
				<div id="camera1wrapper" class="control-left">				
					<div id="camera_joystick" class="joystick control-left light-green-background">
					</div>
				</div>
				<div class="wheels-joystick-wrapper control-right">
					<div id="wheels_joystick" class="wheels-joystick">
					</div>
				</div> 	
			</div>
			<div>
				<div id="controlAreaLeft" class="joystick control-left light-pink-background"></div>
				<div id="controlAreaRight" class="joystick control-right light-blue-background"/></div>
			</div>
			<div>
				<div id="controlAreaLeft2" class="joystick control-left light-orange-background"></div>
				<div id="controlAreaRight2" class="joystick control-right light-green-background"/></div>
			</div>
		</div>
		<script src="js/requestHelper.js"></script>
		<script src="js/Joystick.js"></script>
		<script src="js/WheelsCommandManager.js"></script>
		<script src="js/jquery-3.2.1.min.js"></script>
		<script src="js/requestHelper.js"></script>
		<script src="controls/wheelsJoystick/wheelsJoystick.js"></script>
		<script>

			$(document).ready(function(){

				var wheelsJoysticks = $(".wheels-joystick");

				function sendWheelsState(leftWheelDirection, rightWheelDirection, leftWheelSpeed, rightWheelSpeed){
					httpGetSync(getUrlCommand("wheels="
						+ (rightWheelDirection + leftWheelDirection * 4).toString()
						+ ":" + leftWheelSpeed.toString()
						+ ":" + rightWheelSpeed.toString()),
					null);
				}

				wheelsJoysticks.each(function(index, item){
					var wheelsJoystickDiv = item;
					wheelsJoystick(wheelsJoystickDiv, 25, 255, sendWheelsState);
				})    
			})

		</script>
		<script>			
			
			console.log('main');
			
			const speed = 0.7;		
			
			function servoConf(minAngle, maxAngle, angle, speed){
				return {
					minAngle: minAngle,
					maxAngle: maxAngle,
					angle: angle,
					speed: speed
				}
			}
			
			var controlState = {
				
				angles: function(anglesArr){
					if(anglesArr !== undefined && anglesArr.length <= 0){
						servos.forEach(function(servo, i){servo.angle = anglesArr[i]});
					}
					
					return this.servos.map(function(servo){return servo.angle});
				},
				
				servos: [
					servoConf(0, 180, 90, 0.7),
					servoConf(0, 180, 90, 0.7),
					servoConf(0, 180, 90, 0.7),
					servoConf(0, 180, 90, 0.7),
					servoConf(0, 180, 90, 0.7),
					servoConf(0, 180, 90, 0.7),
					servoConf(0, 180, 90, 0.7),
					servoConf(0, 180, 90, 0.7)
				]
			}
			
			function sendServosAngles(){			
				httpGetSync(getUrlCommand("servos=" + controlState.angles().join("a")), null);
			}
			
			function initJoysticks(){
				joystick(document.getElementById("controlAreaLeft"), controlState.servos[0], controlState.servos[1], sendServosAngles);
				joystick(document.getElementById("controlAreaRight"), controlState.servos[0], controlState.servos[2], sendServosAngles);
				joystick(document.getElementById("controlAreaLeft2"), controlState.servos[4], controlState.servos[3], sendServosAngles);
				joystick(document.getElementById("controlAreaRight2"), controlState.servos[5], servoConf(0, 180, 90, 0.7), sendServosAngles);
			}

			function controlStateFromJson(jsonStr){
				newConfig = JSON.parse(jsonStr);
			
				function validateConfig(newConfig){
					if(newConfig == null ||
						typeof(newConfig) === 'undefined' ||
						newConfig.servos == null ||
						typeof(newConfig.servos) === 'undefined')
					return false;
				
					return newConfig.servos.length === controlState.servos.length;
				}
			
				if(validateConfig(newConfig))
					controlState.servos = newConfig
				
				initJoysticks();
			}
			
			function getServosAngles(){
				httpGetAsync(getUrlCommand("getPositions"), controlStateFromJson);
			}
			
			//getServosAngles();

			initJoysticks();
			
			
		</script>
	</body> 
</html>
